# -*- coding: utf-8 -*-

import io
import os
import pytest
import urllib.request

# Without an empty "tests/__init__.py", this fails:
# ModuleNotFoundError: No module named 'gw2api'
from gw2api import create_app

mock_dict = {
    'https://api.guildwars2.com/v2/account/achievements': 'account_achievements.json.gz',
    'https://api.guildwars2.com/v2/achievements/groups': 'achievements_groups.json.gz',
    'https://api.guildwars2.com/v2/achievements/groups?ids=18DB115A-8637-4290-A636-821362A3C4A8,1CAFA333-0C2B-4782-BC4C-7DA30E9CE289,3A185655-09A5-4F6C-8B21-F1FCF62587B1,45410F60-AB66-4146-A0F7-CE99250C4CB0,4E6A6CE7-B131-40BB-81A3-235CDBACDAA9,56A82BB9-6B07-4AB0-89EE-E4A6D68F5C47,65B4B678-607E-4D97-B458-076C3E96A810,A4ED8379-5B6B-4ECC-B6E1-70C350C902D2,A9F7378E-9C8A-48CC-9505-3094E661D5F6,B42E2379-9599-46CA-9D4A-40A27E192BBE,BE8B9954-5B55-4FCB-9022-B871AD00EAAB': 'achievements_groups_ids.json.gz',
    'https://api.guildwars2.com/v2/achievements/categories': 'achievements_categories.json.gz',
    'https://api.guildwars2.com/v2/achievements/categories?ids=3,10,13,75,76,98,150,191,193,200,201,202,225,233,236,237,239,241,245,246,247,248,250,251,252,253': 'achievements_categories_ids.json.gz',
    'https://api.guildwars2.com/v2/achievements': 'achievements.json.gz',
    'https://api.guildwars2.com/v2/achievements?ids=5001,5002,5003,5005,5006,5007,5008,5009,5010,5011,5012,5013,5014,5015,5016,5017,5018,5020,5023,5024,5025,5026,5027,5028,5029,5030,5031,5032,5034,5035,5036,5037,5038,5039,5041,5042,5043,5044,5045,5046,5047,5048,5049,5050,5051,5052,5053,5054,5055,5056,5057,5058,5060,5061,5062,5063,5064,5067,5068,5069,5070,5071,5073,5074,5075,5076,5077,5078,5079,5080,5081,5082,5083,5084,5085,5086,5087,5088,5089,5090,5091,5092,5093,5094,5095,5096,5097,5098,5099,5100,5101,5102,5103,5104,5105,5106,5107,5108,5109,5110,5111,5112,5113,5115,5116,5117,5118,5119,5120,5121,5122,5123,5124,5125,5126,5127,5128,5129,5130,5131,5132,5133,5134,5135,5136,5137,5138,5139,5140,5141,5142,5143,5144,5145,5146,5147,5148,5149,5150,5151,5152,5153,5154,5155,5156,5157,5158,5159,5160,5161,5162,5163,5164,5165,5167,5168,5169,5170,5171,5172,5173,5174,5175,5177,5178,5179,5181,5182,5183,5184,5185,5186,5188,5189,5191,5192,5193,5194,5196,5197,5198,5199,5200,5201,5202,5203,5204,5205,5206,5207,5208,5209,5211,5212,5213,5214,5215,5217,5218,5220': 'achievements_5001.json.gz',
    'https://api.guildwars2.com/v2/achievements?ids=5221,5222,5223,5224,5225,5226,5227,5228,5229,5230,5231,5232,5233,5236,5237,5238,5239,5240,5243,5244,5245,5246,5247,5248,5249,5251,5252,5253,5255,5256,5257,5258,5259,5260,5261,5262,5264,5265,5266,5267,5268,5269,5270,5271,5273,5274,5275,5277,5278,5279,5280,5281,5282,5284,5285,5287,5288,5290,5291,5293,5294,5295,5296,5297,5298,5299,5300,5301,5302,5303,5304,5305,5306,5307,5308,5309,5310,5311,5312,5313,5314,5315,5316,5317,5318,5319,5320,5322,5323,5324,5325,5326,5327,5329,5330,5331,5332,5333,5334,5335,5336,5337,5338,5339,5340,5341,5342,5344,5345,5346': 'achievements_5221.json.gz',
    'https://api.guildwars2.com/v2/items?ids=92126,92145,92165,92173,92174,92196,93180': 'items_92126.json.gz',
    'https://api.guildwars2.com/v2/account/bank': 'account_bank.json.gz',
    'https://api.guildwars2.com/v2/items?ids=24836,45178,48092,67097,67796,70229,70367,70852,80024,83029,83992,87517,87557,89199,89696': 'items_24836.json.gz',
    'https://api.guildwars2.com/v2/colors?ids=23,24,1150,1576': 'colors_23.json.gz',
    'https://api.guildwars2.com/v2/characters': 'characters.json.gz',
    'https://api.guildwars2.com/v2/characters/Ivan%20Ironheart': 'characters_ivan.json.gz',
    'https://api.guildwars2.com/v2/items?ids=17323,17700,24508,24548,24567,24575,24601,24615,24836,37075,37086,39232,39233,39273,43251,43254,46762,46768,48090,48091,48093,48094,48095,49433,68359,70852,81462,82348,90288,91145,91379': 'items_17323.json.gz',
    'https://api.guildwars2.com/v2/colors?ids=2,23,24,1150,1576': 'colors_2.json.gz',
    'https://api.guildwars2.com/v2/items?ids=8696,8932,9443,12430,15314,15433,17877,17880,20030,21260,21262,21263,23040,24543,24567,24575,24615,36053,36550,41291,42834,43254,46759,46763,46765,46766,54092,67348,67826,69816,71283,74623,74777,74858,78600,79312,81670,82194,83021,83130,83782,83892,84270,84330,84581,84966,85422,85442,85479,89231,92272,93353,93558': 'items_8696.json.gz',
    'https://api.guildwars2.com/v2/colors?ids=320,988,19476,20096,26077,32770,42973': 'colors_empty.json.gz',
    'https://api.guildwars2.com/v2/account/materials': 'account_materials.json.gz',
    'https://api.guildwars2.com/v2/materials': 'materials.json',
    'https://api.guildwars2.com/v2/materials?ids=5,6,29,30,37,38,46,49,50': 'materials_ids.json.gz',
    'https://api.guildwars2.com/v2/items?ids=12134,12135,12142,12147,12163,12165,12236,12238,12246,12255,19679,19697,19704,19710,19718,19719,19720,19723,19738,19792,24272,24278,24284,24290,24296,24301,24306,24311,24316,24321,24326,24331,24336,24342,24346,24352,24464,24465,24466,24467,24468,24469,24470,24500,24501,24534,37897,44941,66930,68952': 'items_12134.json.gz',
    'https://api.guildwars2.com/v2/account/inventory': 'account_inventory.json.gz',
    'https://api.guildwars2.com/v2/items?ids=78177,81752,82081,83305,85656,86205,87287,90025,92140,92694': 'items_78177.json.gz',
    'https://api.guildwars2.com/v2/account/wallet': 'account_wallet.json.gz',
    'https://api.guildwars2.com/v2/currencies?ids=1,2,3,4,5,6,7,9,10,11,12,13,14,15,18,19,20,22,23,24': 'currencies_ids.json.gz',
    'https://api.guildwars2.com/v2/account/recipes': 'account_recipes.json.gz',
    'https://api.guildwars2.com/v2/account/skins': 'account_skins.json.gz',
    'https://api.guildwars2.com/v2/recipes?ids=12082,12083,12084,12085,12088,12093,12096,12101,12106,12109,12110,12111,12114,12119,12123,12125,12129,12130,12132,12138,12140,12143,12148,12149,12152,12158,12160,12165,12173,12175,12176,12181,12182,12188,12189,12191,12197,12199,12200,12201,12202,12207,12213,12214,12215,12217,12220,12222,12225,12233,12234,12235,12236,12238,12239,12241,12243,12244,12247,12248,12254,12255,12256,12258,12261,12262,12263,12266,12267,12269,12271,12272,12275,12280,12282,12283,12289,12292,12295,12296,12298,12300,12303,12306,12308,12341,12344,12348,12371,12374,12428,12433,12434,12437,12440,12442,12443,12444,12445,12447,12450,12453,12454,12455,12457,12462,12463,12465,12467,12469,12470,12472,12473,12474,12475,12478,12479,12480,12481,12484,12486,12489,12491,12492,12493,12495,12496,12500,12501,12502,12504,12505,12507,12509,12511,12512,12516,12650,12652,12653,12654,12655,12659,12660,12700,12706,12727,12789,12790,12791,12792,12793,12794,12795,12796,12797,12798,12799,12802,12807,12811,12813,12815,12816,12817,12825,12832,12834,12842,12843,12850,12859,12867,12869,12876,12884,12885,12897,12898,12921,12923,12928,12958,12967,12972,12977,12979,12996,13001,13013,13016,13017,13027,13028,13032': 'recipes_12082.json.gz',
    'https://api.guildwars2.com/v2/items?ids=24546,24547,24548,24549,24550,24551,24552,24553,24554,24555,24556,24557,24643,24644,24645,24646,24647,24648,24655,24656,24657,24730,24731,24732,82150,82171,82207,82237,82321,82332,82378,82383,82438,82511,82541,82571,82573,82579,82590,82603,82633,82642,82647,82657,82754,82765,82771,82773,82791,82822,82836,82859,82885,82887,82901,82915,82990,83146,83155,83193,83218,83239,83271,83297,83338,83345,83392,83415,83423,83438,83440,83453,83459,83502,83594,83622,83663,83672,83709,83717,83735,83741,83771,83781,83792,83887,83933,83934,83955,83972,83974,84085,84127,84189,84220,84308,84316,84373,84383,84406,84413,84420,84509,84550,84557,84677,84707,84745,84749,84930,85042,85104,85113,85126,85252,85379,85385,85405,85407,85411,85415,85420,85425,85445,85449,85463,85497,85498,85519,85642,85695,85713,85755,85760,85788,85794,85804,85828,85857,85919,85926,85946,86007,86012,86066,86074,86085,86092,86105,86170,86178,86203,86233,86250,86279,86300,86317,86337,86354,86355,86376,86993,87038,87150,87217,87225,87919,87925,88057,88492,88537,88553,88556,88568,88570,88586,88602,88690,88691,88716,88722,88739,88777,88829,88836,88837,88968,89492,89771,89787,89821,89879,89929': 'items_24546.json.gz',
    'https://api.guildwars2.com/v2/skins': 'skins.json.gz',
     'https://api.guildwars2.com/v2/skins?ids=107,2380,4445,4448,4518,5349,5952,6442,7360,7365,7386,7388,7389,7390,7392,7393,7394,7395,7396,7397,7399,7400,7401,7402,7404,7405,7406,7407,7410,7411,7412,7413,7414,7418,7421,7422,7426,7427,7428,7430,7431,7432,7433,7435,7436,7439,7441,7443,7448,7449,7453,7455,7456,7457,7458,7461,7463,7464,7465,7467,7473,7475,7477,7479,7485,7486,7490,7492,7493,7494,7497,7499,7504,7508,7509,7511,7512,7513,7514,7519,7520,7522,7525,7527,7529,7530,7533,7536,7537,7540,7541,7546,7547,7550,7553,7554,7555,7557,7566,7569,7570,7573,7578,7581,7585,7586,7587,7591,7592,7593,7594,7596,7598,7599,7602,7603,7604,7613,7617,7618,7619,7620,7622,7623,7624,7627,7628,7631,7633,7635,7639,7640,7642,7644,7647,7648,7649,7653,7655,7662,7665,7669,7670,7671,7672,7675,7679,7681,7685,7692,7694,7695,7696,7697,7699,7701,7703,7704,7708,7710,7711,7713,7716,7717,7718,7719,7740,7757,7758,7759,7760,7761,7762,7763,7764,7766,7767,7768,7769,7770,7771,7773,7774,7775,7776,7777,7780,7781,7785,7789,7791,7792,7793,7794,7795,7796,7797,7798,7799,7801': 'skins_107.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=107,7360,7365,7386,7457,7829,7830,7832,7837,7838,7842,7852,7853,7864,7865,7875,7876,7877,7880,7883,7899,7901,7903,7906,7908,7912,7915,8592,8599,8609,8610,8613': 'skins_107a.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=2380,4445,4448,4518,5349,6442': 'skins_2380.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=5952,7390,7426,7493,7509,7570,7701': 'skins_5952.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=7493': 'skins_7493.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=9094,9103,9105,9106,9107,9110,9113,9115,9117,9118,9123,9125,9126,9128,9129,9130,9243,9246,9247,9251,9254,9255,9256,9261,9263,9271,9278,9280,9285,9288,9293,9294,9312,9314,9317,9319,9320,9322,9328,9370,9372,9373,9378,9379,9381,9391,9393,9396,9405,9423,9424,9430,9435,9444,9445': 'skins_9094.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=7803,7817,7819,7826,7827,7829,7830,7832,7836,7837,7838,7840,7842,7844,7851,7852,7853,7856,7859,7864,7865,7873,7875,7876,7877,7880,7883,7891,7893,7896,7899,7901,7903,7906,7908,7912,7915,7917,7927,7943,7952,7972,7989,7996,8006,8014,8028,8030,8032,8049,8052,8057,8058,8115,8121,8122,8149,8165,8167,8171,8181,8188,8189,8190,8191,8196,8201,8204,8207,8210,8212,8219,8223,8224,8226,8229,8231,8239,8240,8252,8258,8261,8265,8282,8283,8284,8334,8335,8336,8340,8342,8343,8346,8348,8349,8353,8354,8356,8359,8365,8367,8368,8371,8372,8373,8378,8382,8383,8384,8386,8387,8391,8392,8401,8402,8405,8406,8410,8413,8415,8420,8423,8424,8425,8429,8430,8440,8505,8506,8507,8508,8510,8512,8513,8514,8515,8551,8554,8555,8564,8568,8572,8583,8592,8593,8596,8597,8599,8601,8605,8609,8610,8613,9094,9103,9105,9106,9107,9110,9113,9115,9117,9118,9123,9125,9126,9128,9129,9130,9243,9246,9247,9251,9254,9255,9256,9261,9263,9271,9278,9280,9285,9288,9293,9294,9312,9314,9317,9319,9320,9322,9328,9370,9372,9373,9378,9379,9381,9391,9393': 'skins_7803.json.gz',
    'https://api.guildwars2.com/v2/skins?ids=9396,9405,9423,9424,9430,9435,9444,9445': 'skins_9396.json.gz'
}

orig_urllib_request_urlopen = urllib.request.urlopen


@pytest.fixture
def app():
    app = create_app({
        'TESTING': True
    })
    return app


@pytest.fixture
def client(app):
    return app.test_client()


# https://www.mitchellcurrie.com/blog-post/python-mock-unittesting/

class MockHTTPResponse:
    # https://docs.python.org/3/library/urllib.request.html#urllib.request.urlopen

    def __init__(self, data=None, path=None):
        self.data = data
        self.path = path

    def info(self):
        headers = {}
        if self.path is not None and self.path.endswith('.gz'):
            headers['Content-Encoding'] = 'gzip'
        return headers

    def getcode(self):
        return 200 if data is not None or path is not None else 404

    def read(self):
        if self.path is not None:
            if self.path.endswith('.gz'):
                with open(self.path, 'rb') as f:
                    return f.read()
            else:
                with open(self.path, 'r') as f:
                    return f.read().encode()
        else:
            return self.data

    def close(self):
        pass


def mock_urllib_request_urlopen(url, data=None, timeout=None):
    full_url = url.full_url if isinstance(url, urllib.request.Request) else url
    path = mock_dict.get(full_url)
    if path is None:
        print('request', full_url)
        return orig_urllib_request_urlopen(url, data, timeout)
    else:
        path = os.path.join(os.path.dirname(__file__), 'resources', path)
        print('mock', path)
        return MockHTTPResponse(path=path)
